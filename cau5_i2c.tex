\documentclass[12pt,a4paper]{article}
\usepackage{fontspec}
\usepackage[vietnamese]{babel}
\usepackage{amsmath,amssymb}
\usepackage{siunitx}
\usepackage{geometry}
\usepackage{xcolor}
\usepackage{tikz}
\usetikzlibrary{shapes,arrows,positioning,calc,decorations.pathreplacing}
\usepackage{tikz-timing}
\usepackage{enumitem}
\usepackage{booktabs}
\usepackage{fancyhdr}
\usepackage{tcolorbox}
\usepackage{multirow}

\geometry{margin=2cm}
\pagestyle{fancy}
\fancyhf{}
\fancyhead[L]{EE5215 - Câu 5: Giao thức I2C}
\fancyhead[R]{1.5 điểm}
\fancyfoot[C]{\thepage}

\definecolor{formulabox}{RGB}{230,240,255}
\definecolor{resultbox}{RGB}{220,255,220}
\definecolor{conceptbox}{RGB}{255,245,220}
\definecolor{sda}{RGB}{0,100,200}
\definecolor{scl}{RGB}{200,100,0}

\begin{document}

\begin{center}
\Large\textbf{CÂU HỎI 5: GIAO THỨC I2C}\\[0.3cm]
\large Learning Outcome: L.O.3 | Điểm: 1.5
\end{center}

\section{Đề bài}

Cho kết nối giữa Master và các Slave theo giao thức I2C như hình bên dưới. Mô tả quá trình Master muốn gửi liên tục 2 byte data \texttt{12H} và \texttt{34H} xuống Slave 2 từ lúc bắt đầu cho đến kết thúc khung truyền.

\textbf{Địa chỉ các Slave:}
\begin{center}
\begin{tabular}{|c|c|}
\hline
\textbf{Slave} & \textbf{Địa chỉ (7-bit)} \\
\hline
Slave 1 & \texttt{1101001} \\
\hline
Slave 2 & \texttt{1001100} \\
\hline
Slave 3 & \texttt{0100111} \\
\hline
\end{tabular}
\end{center}

\section{Kiến thức nền tảng về I2C}

\subsection{Tổng quan I2C}

\begin{tcolorbox}[colback=conceptbox,title=I2C là gì?]
\textbf{I2C} (Inter-Integrated Circuit) hay còn gọi là \textbf{TWI} (Two-Wire Interface) là giao thức truyền thông nối tiếp đồng bộ, sử dụng 2 dây:

\begin{itemize}
    \item \textbf{SDA} (Serial Data): Dây dữ liệu
    \item \textbf{SCL} (Serial Clock): Dây xung nhịp
\end{itemize}

\textbf{Đặc điểm:}
\begin{itemize}
    \item Half-duplex (hai chiều nhưng không đồng thời)
    \item Multi-master, multi-slave
    \item Tốc độ: 100 kbps (Standard), 400 kbps (Fast), 3.4 Mbps (High-speed)
    \item Open-drain với pull-up resistors
\end{itemize}
\end{tcolorbox}

\subsection{Sơ đồ kết nối I2C}

\begin{center}
\begin{tikzpicture}[scale=0.9]
    % VCC and Pull-up resistors
    \node at (4,4.5) {$V_{CC}$};
    \draw (4,4.5) -- (4,4);
    \draw (2,4) -- (6,4);
    
    % Pull-up resistors
    \draw (2.5,4) -- (2.5,3.5);
    \draw[thick] (2.3,3.5) rectangle (2.7,3);
    \node at (2.5,3.2) {\tiny Rp};
    \draw (2.5,3) -- (2.5,2.5);
    
    \draw (5.5,4) -- (5.5,3.5);
    \draw[thick] (5.3,3.5) rectangle (5.7,3);
    \node at (5.5,3.2) {\tiny Rp};
    \draw (5.5,3) -- (5.5,2.5);
    
    % SDA and SCL lines
    \draw[thick,sda] (0,2.5) -- (8,2.5);
    \node[sda] at (8.5,2.5) {SDA};
    \draw[thick,scl] (0,1.5) -- (8,1.5);
    \node[scl] at (8.5,1.5) {SCL};
    
    % Master
    \draw[fill=blue!20] (-0.5,0) rectangle (1.5,2);
    \node at (0.5,1) {Master};
    \draw (0.5,2) -- (0.5,2.5);
    \draw (0.8,2) -- (0.8,1.5);
    
    % Slave 1
    \draw[fill=green!20] (2,0) rectangle (3.5,2);
    \node at (2.75,1.2) {\tiny Slave 1};
    \node at (2.75,0.6) {\tiny 1101001};
    \draw (2.75,2) -- (2.75,2.5);
    \draw (3,2) -- (3,1.5);
    
    % Slave 2 (highlighted)
    \draw[fill=yellow!40,thick] (4,0) rectangle (5.5,2);
    \node at (4.75,1.2) {\tiny \textbf{Slave 2}};
    \node at (4.75,0.6) {\tiny \textbf{1001100}};
    \draw (4.75,2) -- (4.75,2.5);
    \draw (5,2) -- (5,1.5);
    
    % Slave 3
    \draw[fill=green!20] (6,0) rectangle (7.5,2);
    \node at (6.75,1.2) {\tiny Slave 3};
    \node at (6.75,0.6) {\tiny 0100111};
    \draw (6.75,2) -- (6.75,2.5);
    \draw (7,2) -- (7,1.5);
\end{tikzpicture}
\end{center}

\subsection{Cấu trúc Frame I2C}

\begin{tcolorbox}[colback=formulabox,title=Cấu trúc khung truyền I2C]
Mỗi transaction I2C bao gồm:

\begin{center}
\begin{tikzpicture}[scale=0.6]
    % Start
    \draw[fill=red!30] (0,0) rectangle (1,1);
    \node at (0.5,0.5) {\tiny S};
    \node at (0.5,-0.3) {\tiny Start};
    
    % Address (7 bits)
    \draw[fill=blue!30] (1,0) rectangle (5,1);
    \node at (3,0.5) {\tiny Address (7 bit)};
    
    % R/W
    \draw[fill=purple!30] (5,0) rectangle (6,1);
    \node at (5.5,0.5) {\tiny R/W};
    
    % ACK
    \draw[fill=green!30] (6,0) rectangle (7,1);
    \node at (6.5,0.5) {\tiny A};
    \node at (6.5,-0.3) {\tiny ACK};
    
    % Data 1
    \draw[fill=orange!30] (7,0) rectangle (11,1);
    \node at (9,0.5) {\tiny Data 1 (8 bit)};
    
    % ACK
    \draw[fill=green!30] (11,0) rectangle (12,1);
    \node at (11.5,0.5) {\tiny A};
    
    % Data 2
    \draw[fill=orange!30] (12,0) rectangle (16,1);
    \node at (14,0.5) {\tiny Data 2 (8 bit)};
    
    % ACK
    \draw[fill=green!30] (16,0) rectangle (17,1);
    \node at (16.5,0.5) {\tiny A};
    
    % Stop
    \draw[fill=red!30] (17,0) rectangle (18,1);
    \node at (17.5,0.5) {\tiny P};
    \node at (17.5,-0.3) {\tiny Stop};
\end{tikzpicture}
\end{center}

\textbf{Giải thích:}
\begin{itemize}
    \item \textbf{S (Start):} Master kéo SDA từ HIGH xuống LOW khi SCL vẫn HIGH
    \item \textbf{Address:} 7 bit địa chỉ Slave (MSB first)
    \item \textbf{R/W:} 0 = Write (ghi), 1 = Read (đọc)
    \item \textbf{A (ACK):} Slave kéo SDA xuống LOW để xác nhận
    \item \textbf{Data:} 8 bit dữ liệu (MSB first)
    \item \textbf{P (Stop):} Master kéo SDA từ LOW lên HIGH khi SCL đang HIGH
\end{itemize}
\end{tcolorbox}

\subsection{Start và Stop Condition}

\begin{center}
\begin{tikzpicture}[scale=0.8]
    % Start condition
    \node at (-1,3) {\textbf{Start Condition:}};
    \draw[->] (0,0) -- (5,0) node[right] {t};
    
    % SCL
    \draw[thick,scl] (0,2) -- (1,2) -- (1,1) -- (2,1) -- (2,2) -- (3,2) -- (3,1) -- (4,1);
    \node[scl] at (-0.5,1.5) {SCL};
    
    % SDA
    \draw[thick,sda] (0,3) -- (0.5,3) -- (0.5,2.5) -- (4,2.5);
    \node[sda] at (-0.5,2.75) {SDA};
    
    % Annotation
    \draw[<-,thick] (0.5,2.7) -- (0.5,3.5) node[above] {\tiny SDA: HIGH$\rightarrow$LOW};
    \draw[<->,thick] (0.2,2.2) -- (0.8,2.2);
    \node at (0.5,2.4) {\tiny SCL = HIGH};
    
    % Stop condition
    \node at (7,3) {\textbf{Stop Condition:}};
    \draw[->] (8,0) -- (13,0) node[right] {t};
    
    % SCL
    \draw[thick,scl] (8,1) -- (9,1) -- (9,2) -- (10,2) -- (10,1) -- (11,1) -- (11,2) -- (12,2);
    \node[scl] at (7.5,1.5) {SCL};
    
    % SDA
    \draw[thick,sda] (8,2.5) -- (10.5,2.5) -- (10.5,3) -- (12,3);
    \node[sda] at (7.5,2.75) {SDA};
    
    % Annotation
    \draw[<-,thick] (10.5,2.7) -- (10.5,3.5) node[above] {\tiny SDA: LOW$\rightarrow$HIGH};
    \draw[<->,thick] (10.2,2.2) -- (10.8,2.2);
    \node at (10.5,2.4) {\tiny SCL = HIGH};
\end{tikzpicture}
\end{center}

\section{Lời giải chi tiết}

\subsection{Thông tin cần truyền}

\begin{tcolorbox}[colback=white]
\textbf{Master gửi đến Slave 2:}
\begin{itemize}
    \item Địa chỉ Slave 2: \texttt{1001100} (7 bit)
    \item Hướng truyền: Write (R/W = 0)
    \item Byte 1: \texttt{0x12} = \texttt{00010010} (binary)
    \item Byte 2: \texttt{0x34} = \texttt{00110100} (binary)
\end{itemize}
\end{tcolorbox}

\subsection{Chuyển đổi dữ liệu}

\begin{tcolorbox}[colback=formulabox]
\textbf{Address frame:} Slave 2 address + Write
\begin{center}
\begin{tabular}{|c|c|c|c|c|c|c|c|}
\hline
\multicolumn{7}{|c|}{Address (7 bit)} & R/W \\
\hline
1 & 0 & 0 & 1 & 1 & 0 & 0 & 0 \\
\hline
\end{tabular}
= \texttt{0x98}
\end{center}

\textbf{Data 1:} \texttt{0x12}
\begin{center}
\begin{tabular}{|c|c|c|c|c|c|c|c|}
\hline
0 & 0 & 0 & 1 & 0 & 0 & 1 & 0 \\
\hline
\end{tabular}
\end{center}

\textbf{Data 2:} \texttt{0x34}
\begin{center}
\begin{tabular}{|c|c|c|c|c|c|c|c|}
\hline
0 & 0 & 1 & 1 & 0 & 1 & 0 & 0 \\
\hline
\end{tabular}
\end{center}
\end{tcolorbox}

\subsection{Mô tả từng bước quá trình truyền}

\begin{tcolorbox}[colback=resultbox,title=Quy trình truyền I2C chi tiết]

\textbf{Bước 1: START Condition}
\begin{itemize}
    \item Master khởi tạo giao tiếp
    \item Master kéo SDA từ HIGH $\rightarrow$ LOW trong khi SCL đang HIGH
    \item Tất cả các Slave đều ``lắng nghe''
    \item Thời gian: 1 clock
\end{itemize}

\textbf{Bước 2: Gửi Address Frame (8 bit)}
\begin{itemize}
    \item Master gửi 7 bit địa chỉ + 1 bit R/W
    \item Địa chỉ: \texttt{1001100}, R/W = 0 (Write)
    \item Frame hoàn chỉnh: \texttt{10011000} = \texttt{0x98}
    \item Truyền MSB first: 1 $\rightarrow$ 0 $\rightarrow$ 0 $\rightarrow$ 1 $\rightarrow$ 1 $\rightarrow$ 0 $\rightarrow$ 0 $\rightarrow$ 0
    \item Thời gian: 8 clock cycles
\end{itemize}

\textbf{Bước 3: ACK từ Slave 2}
\begin{itemize}
    \item Slave 2 nhận ra địa chỉ \texttt{1001100} là của mình
    \item Slave 2 kéo SDA xuống LOW (ACK = 0)
    \item Slave 1 và Slave 3 không phản hồi (địa chỉ không khớp)
    \item Thời gian: 1 clock
\end{itemize}

\textbf{Bước 4: Gửi Data Byte 1 (0x12)}
\begin{itemize}
    \item Master gửi 8 bit: \texttt{00010010}
    \item Truyền MSB first: 0 $\rightarrow$ 0 $\rightarrow$ 0 $\rightarrow$ 1 $\rightarrow$ 0 $\rightarrow$ 0 $\rightarrow$ 1 $\rightarrow$ 0
    \item Thời gian: 8 clock cycles
\end{itemize}

\textbf{Bước 5: ACK từ Slave 2}
\begin{itemize}
    \item Slave 2 kéo SDA xuống LOW để xác nhận đã nhận byte 1
    \item Thời gian: 1 clock
\end{itemize}

\textbf{Bước 6: Gửi Data Byte 2 (0x34)}
\begin{itemize}
    \item Master gửi 8 bit: \texttt{00110100}
    \item Truyền MSB first: 0 $\rightarrow$ 0 $\rightarrow$ 1 $\rightarrow$ 1 $\rightarrow$ 0 $\rightarrow$ 1 $\rightarrow$ 0 $\rightarrow$ 0
    \item Thời gian: 8 clock cycles
\end{itemize}

\textbf{Bước 7: ACK từ Slave 2}
\begin{itemize}
    \item Slave 2 kéo SDA xuống LOW để xác nhận đã nhận byte 2
    \item Thời gian: 1 clock
\end{itemize}

\textbf{Bước 8: STOP Condition}
\begin{itemize}
    \item Master kết thúc giao tiếp
    \item Master kéo SDA từ LOW $\rightarrow$ HIGH trong khi SCL đang HIGH
    \item Bus trở về trạng thái idle
    \item Thời gian: 1 clock
\end{itemize}
\end{tcolorbox}

\subsection{Timing Diagram}

% Chi tiết Timing Diagram với sóng vuông đẹp
\begin{center}
\resizebox{\textwidth}{!}{%
\begin{tikzpicture}[
    high/.style={line width=1.5pt, blue!70!black},
    low/.style={line width=1.5pt, blue!70!black},
    sclline/.style={line width=1.5pt, orange!80!black},
    bitlabel/.style={font=\footnotesize\bfseries},
    framelabel/.style={font=\small\bfseries, fill=white, inner sep=2pt}
]

% Định nghĩa các thông số
\def\bitwidth{0.8}
\def\sclheight{1}
\def\sdaheight{3}
\def\gap{0.1}

% ============ VẼ SCL (Clock) ============
\node[anchor=east, font=\bfseries] at (-0.5, \sclheight) {SCL};

% Vẽ xung clock - 28 clock pulses + start/stop
\foreach \i in {0,1,...,28} {
    \pgfmathsetmacro{\xstart}{\i*\bitwidth}
    % Low phase
    \draw[sclline] (\xstart, 0.5) -- (\xstart+\gap, 0.5) -- (\xstart+\gap, \sclheight+0.5);
    % High phase
    \draw[sclline] (\xstart+\gap, \sclheight+0.5) -- (\xstart+\bitwidth-\gap, \sclheight+0.5);
    % Transition down
    \draw[sclline] (\xstart+\bitwidth-\gap, \sclheight+0.5) -- (\xstart+\bitwidth-\gap, 0.5);
    \draw[sclline] (\xstart+\bitwidth-\gap, 0.5) -- (\xstart+\bitwidth, 0.5);
}

% ============ VẼ SDA (Data) ============
\node[anchor=east, font=\bfseries] at (-0.5, \sdaheight) {SDA};

% Start condition: SDA drops while SCL high
\draw[high] (0, \sdaheight+0.5) -- (0.2, \sdaheight+0.5);
\draw[high] (0.2, \sdaheight+0.5) -- (0.2, \sdaheight-0.5);
\node[above, font=\tiny\bfseries, red!70!black] at (0.1, \sdaheight+0.7) {START};

% Address bits: 1 0 0 1 1 0 0 + R/W=0
% Bit 0: HIGH (1)
\draw[high] (0.2, \sdaheight-0.5) -- (0.4, \sdaheight-0.5) -- (0.4, \sdaheight+0.5) -- (0.8, \sdaheight+0.5);
\node[bitlabel] at (0.6, \sdaheight+0.9) {1};

% Bit 1: LOW (0)
\draw[high] (0.8, \sdaheight+0.5) -- (0.8, \sdaheight-0.5) -- (1.6, \sdaheight-0.5);
\node[bitlabel] at (1.2, \sdaheight+0.9) {0};

% Bit 2: LOW (0)
\draw[high] (1.6, \sdaheight-0.5) -- (2.4, \sdaheight-0.5);
\node[bitlabel] at (2.0, \sdaheight+0.9) {0};

% Bit 3: HIGH (1)
\draw[high] (2.4, \sdaheight-0.5) -- (2.4, \sdaheight+0.5) -- (3.2, \sdaheight+0.5);
\node[bitlabel] at (2.8, \sdaheight+0.9) {1};

% Bit 4: HIGH (1)
\draw[high] (3.2, \sdaheight+0.5) -- (4.0, \sdaheight+0.5);
\node[bitlabel] at (3.6, \sdaheight+0.9) {1};

% Bit 5: LOW (0)
\draw[high] (4.0, \sdaheight+0.5) -- (4.0, \sdaheight-0.5) -- (4.8, \sdaheight-0.5);
\node[bitlabel] at (4.4, \sdaheight+0.9) {0};

% Bit 6: LOW (0)
\draw[high] (4.8, \sdaheight-0.5) -- (5.6, \sdaheight-0.5);
\node[bitlabel] at (5.2, \sdaheight+0.9) {0};

% Bit 7: R/W = LOW (0 = Write)
\draw[high] (5.6, \sdaheight-0.5) -- (6.4, \sdaheight-0.5);
\node[bitlabel, red] at (6.0, \sdaheight+0.9) {W};

% ACK from Slave (LOW)
\draw[high, green!60!black] (6.4, \sdaheight-0.5) -- (7.2, \sdaheight-0.5);
\node[bitlabel, green!60!black] at (6.8, \sdaheight+0.9) {A};

% Data 1: 0x12 = 0001 0010
% Bit 0: LOW
\draw[high] (7.2, \sdaheight-0.5) -- (8.0, \sdaheight-0.5);
\node[bitlabel] at (7.6, \sdaheight+0.9) {0};

% Bit 1: LOW
\draw[high] (8.0, \sdaheight-0.5) -- (8.8, \sdaheight-0.5);
\node[bitlabel] at (8.4, \sdaheight+0.9) {0};

% Bit 2: LOW
\draw[high] (8.8, \sdaheight-0.5) -- (9.6, \sdaheight-0.5);
\node[bitlabel] at (9.2, \sdaheight+0.9) {0};

% Bit 3: HIGH
\draw[high] (9.6, \sdaheight-0.5) -- (9.6, \sdaheight+0.5) -- (10.4, \sdaheight+0.5);
\node[bitlabel] at (10.0, \sdaheight+0.9) {1};

% Bit 4: LOW
\draw[high] (10.4, \sdaheight+0.5) -- (10.4, \sdaheight-0.5) -- (11.2, \sdaheight-0.5);
\node[bitlabel] at (10.8, \sdaheight+0.9) {0};

% Bit 5: LOW
\draw[high] (11.2, \sdaheight-0.5) -- (12.0, \sdaheight-0.5);
\node[bitlabel] at (11.6, \sdaheight+0.9) {0};

% Bit 6: HIGH
\draw[high] (12.0, \sdaheight-0.5) -- (12.0, \sdaheight+0.5) -- (12.8, \sdaheight+0.5);
\node[bitlabel] at (12.4, \sdaheight+0.9) {1};

% Bit 7: LOW
\draw[high] (12.8, \sdaheight+0.5) -- (12.8, \sdaheight-0.5) -- (13.6, \sdaheight-0.5);
\node[bitlabel] at (13.2, \sdaheight+0.9) {0};

% ACK
\draw[high, green!60!black] (13.6, \sdaheight-0.5) -- (14.4, \sdaheight-0.5);
\node[bitlabel, green!60!black] at (14.0, \sdaheight+0.9) {A};

% Data 2: 0x34 = 0011 0100
% Bit 0: LOW
\draw[high] (14.4, \sdaheight-0.5) -- (15.2, \sdaheight-0.5);
\node[bitlabel] at (14.8, \sdaheight+0.9) {0};

% Bit 1: LOW
\draw[high] (15.2, \sdaheight-0.5) -- (16.0, \sdaheight-0.5);
\node[bitlabel] at (15.6, \sdaheight+0.9) {0};

% Bit 2: HIGH
\draw[high] (16.0, \sdaheight-0.5) -- (16.0, \sdaheight+0.5) -- (16.8, \sdaheight+0.5);
\node[bitlabel] at (16.4, \sdaheight+0.9) {1};

% Bit 3: HIGH
\draw[high] (16.8, \sdaheight+0.5) -- (17.6, \sdaheight+0.5);
\node[bitlabel] at (17.2, \sdaheight+0.9) {1};

% Bit 4: LOW
\draw[high] (17.6, \sdaheight+0.5) -- (17.6, \sdaheight-0.5) -- (18.4, \sdaheight-0.5);
\node[bitlabel] at (18.0, \sdaheight+0.9) {0};

% Bit 5: HIGH
\draw[high] (18.4, \sdaheight-0.5) -- (18.4, \sdaheight+0.5) -- (19.2, \sdaheight+0.5);
\node[bitlabel] at (18.8, \sdaheight+0.9) {1};

% Bit 6: LOW
\draw[high] (19.2, \sdaheight+0.5) -- (19.2, \sdaheight-0.5) -- (20.0, \sdaheight-0.5);
\node[bitlabel] at (19.6, \sdaheight+0.9) {0};

% Bit 7: LOW
\draw[high] (20.0, \sdaheight-0.5) -- (20.8, \sdaheight-0.5);
\node[bitlabel] at (20.4, \sdaheight+0.9) {0};

% ACK
\draw[high, green!60!black] (20.8, \sdaheight-0.5) -- (21.6, \sdaheight-0.5);
\node[bitlabel, green!60!black] at (21.2, \sdaheight+0.9) {A};

% Stop condition: SDA rises while SCL high
\draw[high] (21.6, \sdaheight-0.5) -- (22.0, \sdaheight-0.5);
\draw[high] (22.0, \sdaheight-0.5) -- (22.0, \sdaheight+0.5) -- (23.2, \sdaheight+0.5);
\node[above, font=\tiny\bfseries, red!70!black] at (22.2, \sdaheight+0.7) {STOP};

% ============ FRAME LABELS ============
% Address frame bracket
\draw[decorate, decoration={brace, amplitude=5pt, mirror}, thick, purple!70!black] 
    (0.4, -0.3) -- (6.4, -0.3) node[midway, below=8pt, framelabel, purple!70!black] {Address: 1001100 + W};

% ACK bracket
\draw[decorate, decoration={brace, amplitude=3pt, mirror}, thick, green!60!black] 
    (6.4, -0.3) -- (7.2, -0.3) node[midway, below=6pt, font=\tiny, green!60!black] {ACK};

% Data 1 bracket
\draw[decorate, decoration={brace, amplitude=5pt, mirror}, thick, orange!70!black] 
    (7.2, -0.3) -- (13.6, -0.3) node[midway, below=8pt, framelabel, orange!70!black] {Data 1: 0x12};

% ACK bracket
\draw[decorate, decoration={brace, amplitude=3pt, mirror}, thick, green!60!black] 
    (13.6, -0.3) -- (14.4, -0.3) node[midway, below=6pt, font=\tiny, green!60!black] {ACK};

% Data 2 bracket
\draw[decorate, decoration={brace, amplitude=5pt, mirror}, thick, cyan!70!black] 
    (14.4, -0.3) -- (20.8, -0.3) node[midway, below=8pt, framelabel, cyan!70!black] {Data 2: 0x34};

% ACK bracket
\draw[decorate, decoration={brace, amplitude=3pt, mirror}, thick, green!60!black] 
    (20.8, -0.3) -- (21.6, -0.3) node[midway, below=6pt, font=\tiny, green!60!black] {ACK};

% ============ CLOCK NUMBERS ============
\foreach \i in {1,2,...,28} {
    \pgfmathsetmacro{\xpos}{(\i-0.5)*\bitwidth}
    \node[font=\tiny, gray] at (\xpos, -0.9) {\i};
}

% ============ LEGEND ============
\node[anchor=west, font=\footnotesize] at (0, -1.8) {
    \textcolor{orange!80!black}{\rule{1cm}{2pt}} SCL (Clock) \quad
    \textcolor{blue!70!black}{\rule{1cm}{2pt}} SDA (Data) \quad
    \textcolor{green!60!black}{\textbf{A}} = ACK (Slave) \quad
    \textcolor{red}{\textbf{W}} = Write
};

\end{tikzpicture}
}
\end{center}

% Thêm sơ đồ khối đơn giản hơn
\vspace{0.5cm}
\begin{center}
\begin{tikzpicture}[scale=0.9]
    % Frame boxes
    \draw[fill=red!20, thick] (0,0) rectangle (0.8,0.8);
    \node at (0.4,0.4) {\textbf{S}};
    \node at (0.4,-0.3) {\scriptsize Start};
    
    \draw[fill=purple!20, thick] (1,0) rectangle (4.2,0.8);
    \node at (2.6,0.4) {\textbf{1001100 + 0}};
    \node at (2.6,-0.3) {\scriptsize Address + W};
    
    \draw[fill=green!30, thick] (4.4,0) rectangle (5.2,0.8);
    \node at (4.8,0.4) {\textbf{A}};
    \node at (4.8,-0.3) {\scriptsize ACK};
    
    \draw[fill=orange!20, thick] (5.4,0) rectangle (8.6,0.8);
    \node at (7,0.4) {\textbf{00010010}};
    \node at (7,-0.3) {\scriptsize 0x12};
    
    \draw[fill=green!30, thick] (8.8,0) rectangle (9.6,0.8);
    \node at (9.2,0.4) {\textbf{A}};
    \node at (9.2,-0.3) {\scriptsize ACK};
    
    \draw[fill=cyan!20, thick] (9.8,0) rectangle (13,0.8);
    \node at (11.4,0.4) {\textbf{00110100}};
    \node at (11.4,-0.3) {\scriptsize 0x34};
    
    \draw[fill=green!30, thick] (13.2,0) rectangle (14,0.8);
    \node at (13.6,0.4) {\textbf{A}};
    \node at (13.6,-0.3) {\scriptsize ACK};
    
    \draw[fill=red!20, thick] (14.2,0) rectangle (15,0.8);
    \node at (14.6,0.4) {\textbf{P}};
    \node at (14.6,-0.3) {\scriptsize Stop};
    
    % Bit counts
    \node at (0.4,1.1) {\scriptsize 1};
    \node at (2.6,1.1) {\scriptsize 8 bit};
    \node at (4.8,1.1) {\scriptsize 1};
    \node at (7,1.1) {\scriptsize 8 bit};
    \node at (9.2,1.1) {\scriptsize 1};
    \node at (11.4,1.1) {\scriptsize 8 bit};
    \node at (13.6,1.1) {\scriptsize 1};
    \node at (14.6,1.1) {\scriptsize 1};
\end{tikzpicture}
\end{center}

\subsection{Tổng kết số clock cycles}

\begin{tcolorbox}[colback=resultbox]
\begin{center}
\begin{tabular}{|l|c|}
\hline
\textbf{Thành phần} & \textbf{Số clock} \\
\hline
Start condition & 1 \\
\hline
Address + R/W (8 bit) & 8 \\
\hline
ACK 1 & 1 \\
\hline
Data 1 (8 bit) & 8 \\
\hline
ACK 2 & 1 \\
\hline
Data 2 (8 bit) & 8 \\
\hline
ACK 3 & 1 \\
\hline
Stop condition & 1 \\
\hline
\hline
\textbf{Tổng cộng} & \textbf{29 clock cycles} \\
\hline
\end{tabular}
\end{center}
\end{tcolorbox}

\section{Các trường hợp đặc biệt}

\begin{tcolorbox}[colback=conceptbox]
\textbf{1. NACK (Not Acknowledge):}
\begin{itemize}
    \item Slave không kéo SDA xuống LOW
    \item Nguyên nhân: Slave bận, địa chỉ sai, lỗi
    \item Master có thể retry hoặc tạo STOP
\end{itemize}

\textbf{2. Repeated Start:}
\begin{itemize}
    \item Master tạo START mới mà không cần STOP trước
    \item Dùng khi đổi hướng đọc/ghi hoặc đổi Slave
\end{itemize}

\textbf{3. Clock Stretching:}
\begin{itemize}
    \item Slave giữ SCL ở LOW để chậm lại giao tiếp
    \item Master phải chờ SCL được release
\end{itemize}
\end{tcolorbox}

\end{document}
